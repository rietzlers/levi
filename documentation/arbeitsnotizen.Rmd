---
title: "Arbeitsnotizen"
author: "Stephan Rietzler"
date: "12/17/2019"
output: 
  html_notebook:
    code_folding: hide
---

```{r include=FALSE}
library(tidyverse)
library(magrittr)
library(zeallot)
library(cowplot)
library(plotly)
library(shiny)
library(janitor)
library(levi)
```


# Signal- und Legierungsdaten

 - Laden der axial-oder radial-datensätze:
    * festlegung der heizpulse und abkühlungsphase
    * Mittelwert-Zentrierung/Glättung !?
 - Einlesen/Eingabe der Proben-Daten
    * radius, masse, schmelztemperatur


# Signal-Analysis

Auswahl eines Signals und Zeitfensters. Bestimmung der dominanten 
Frequenz in diesem Zeitfenster

# Frequenz-Schätzer

Die *dominante Schwingungs-Frequenz* der Kugel kann aus den zur Verfügung stehenden Signalen
auf unterschiedliche Art ermittelt werden: 

 - Die zur maximalen Amplitude der Fourier-Koeffizienten gehörende Frequenz.
 - Lorentz-Fit an das Betragsquadrat der Amplituden.

Dabei ist folgendes zu beachten: 

 -  Das Signal kann vorher aufbereitet werden (Glättung, Mittelung usw. )
 -  Die Fourier-Koeffizeienten können verschieden berechnet werden: 
 über die Standard-Funktion ```spectrum ``` oder mit   der Funktion ```fft```.


# Freq.-Bestimmung durch Lorentz-Fit

## Motivation

Ein gedämpfter harmonischer Oszillator gnügt folgender Gleichung: (siehe [Lorentz-Kurve](https://de.wikipedia.org/wiki/Lorentzkurve))
\[\ddot{x} + 2\gamma \dot{x} + \omega_0^2 x = f(t)\]
Eine partikuläre Lösung ist:
\[x(t) = A \cdot e^{-\gamma\cdot t}\cdot e^{i \sqrt{\omega_0^2 - \gamma^2}\cdot t} \] 


Das **Betragsquadrat** der Fourier-Transformierten ist:
\[f(\omega) = \frac{|A(\omega)|^2}{(\omega^2 - \omega_0^2)^2 + \large(2\gamma\large)^2\omega^2} \]

Wobei $A(\omega)$ die Fouriertransformierte von $f(t)$ ist. Unterstellt man eine kurze Impulsanregung so kann
$A(\omega)$ als näherungsweise unabhängig von $\omega$ angesetzt werden.

Die theoretische Spektraldichte dieses Signals ist damit porportional zu:
\[f(\omega) \sim \frac{A}{(\omega^2 - \omega_0^2)^2 + \large(2\gamma\large)^2\omega^2} \]

Ein heuristischen Ansatz für die Modellierung der Oszillation der Kugeloberfläche ist der gedämpfte
harmonische Oszillator.  Aus diesem Grund wird einel Lorentz-Kurve an die quadrierten 
Amplituden der Fourier-Frequenzen gefittet und daraus die Eigen-Frequenz $\omega_0$ 
und die Dämpfung $\lambda$ ermittelt.

## Einschränkungen

* Für $\omega \rightarrow \infty$ geht die Lorentz-Kurve gegen Null. Die
Amplituden-Werte der Fourie-Koeffizeinten repräsentieren aber hochfrequentes
Rauschen und bleiben deswegen (statistisch) positiv endlich. Die Anpassung der
Lorentz-Kurve muß auf ein Frequenz-Band um die dominante Freq. beschränkt werden.
**Wie soll diese Breite festgelegt werden?**

* Das endliche sampling führt zu einer Verbreiterung des theoretischen 
Spektrums: Ein Rechteck-Taper hat die Fejer-Funktion als Spektralfenster.
Als 'Maß' für die Breite des Fejer-Fensters kann man als richtwert eine
Fourier-Frequenz setzen. Also 1/N $\cdot$ samplerate = $1/T$ wobei T die 
Beobachtungs-Dauer bzw. Länge des Taper-Fensters ist.

```{r}
fejer <- function(w, N){if_else(w==0, N, 1/N*(sin(pi*w*N)/sin(pi*w))^2)}
w <- seq(-0.5, 0.5, by = .0001)

d <- tidyr::expand_grid(w, N = 2^seq(6,9)) %>% mutate(famps = fejer(w,N))

fejer_graph <- 
  d %>% 
  group_by(N) %>%  
  mutate(
    f = w*N, # alle signale werden eine sekunde aufgezeichnet -> sr = 1/N 
    damping = log10(famps/max(famps, na.rm = TRUE))
    ) %>% 
  ungroup() %>% 
  filter(!(near(abs(w), 0.5))) %>% 
  ggplot(aes(x = f, y = damping)) + 
  geom_line(aes(color = factor(N))) +
ylim(c(-40, 0))

fejer_graph %>% plotly::ggplotly()
```

Typische Werte der Frequenz sind von ca. 34 - 32Hz

```{r}
f_s <- function(st, m){sqrt(8/3*st/(pi*m))}
m <- 1.29224 / 1000
st <- 1.6
f_s(st, m)
```

Typische werte der Dämpfung: 0.5 - 0.3 

```{r}
eta <- 8.47/1000
r <- 3.264/1000
d <- function(r,m ){20*pi/3*r/m * eta}
d(r, m)
```

Erwartungswert direkter Spektralschätzer

```{r}
sr <- 129
srn <- nextn(sr, factors = c(2))
w0 <- 30
d <- 0.1

fejer <- function(w, N){if_else(w==0, N, 1/N*(sin(pi*w*N)/sin(pi*w))^2)}

lorentz_spec <- function(w){w <- w*sr; 10^4/((w^2 - (w0)^2)^2 + (2*d)^2*w^2)}

exp_spec <- function(l, spec){
  integrand <- Vectorize(function(w){spec(w)*fejer(l-w, sr)}, vectorize.args = c("w"))
  integrate(integrand, -.5, .5, stop.on.error = FALSE)$value
}


ep_data <- 
  tibble(
    w = seq(0, .5, by = 1/srn),
    th_spec = lorentz_spec(w),
    expected_spec = map_dbl(w, exp_spec, lorentz_spec),
    f = w*sr,
    fc_amp = sqrt(rexp(n=length(f), r = 1/th_spec))
    )
  
fitted <- (ep_data %>%  fit_lorentz(c0 = c(A = 10^4, f0 = w0, g = d)))$fitted

(
  ep_data %>% 
  ggplot(aes(x = w)) +
  geom_line(aes(y = th_spec), color = "red") +
  geom_vline(xintercept = w0/sr) +
  geom_line(aes(y = expected_spec), color = "blue") +
  geom_point(data = tibble(w = (0:(sr/2))/sr,
                           fcamp = map_dbl(w, exp_spec, lorentz_spec)),
             aes(x = w, y = fcamp), color = "blue") +
  geom_point(data = tibble(w = (0:(srn/2-1))/srn, 
                           fcamp = map_dbl(w, exp_spec, lorentz_spec)),
             aes(x = w, y = fcamp), color = "blue", shape = "x") +
  geom_point(aes(y= fc_amp^2), color = "green" , shape = "+") +
  geom_line(data = fitted, aes(y = lf_amp^2), color = "green") +
  scale_x_continuous(sec.axis = sec_axis(~ .*sr)) +
  scale_y_continuous(trans = "log10")
) %>% 
  ggplotly()


```


